angular.module("afkl.lazyImage",[]),angular.module("afkl.lazyImage").service("afklSrcSetService",["$window",function(e){"use strict";function n(e){this.src=e.src,this.w=e.w||1/0,this.h=e.h||1/0,this.x=e.x||1}function t(e,n){var t,r;return function(){var o=+new Date;t&&t+n>o?(clearTimeout(r),r=setTimeout(function(){t=o,e()},n+t-o)):(t=o,e())}}var r=/^[0-9]+$/,o=function(e){for(var n=e.split(/\s/),t={},o=0,a=n.length;a>o;o++){var i=n[o];if(i.length>0){var l=i.slice(-1),c=i.substring(0,i.length-1),u=parseInt(c,10),f=parseFloat(c);c.match(r)&&"w"===l?t[l]=u:c.match(r)&&"h"===l?t[l]=u:isNaN(f)||"x"!==l||(t[l]=f)}}return t},a=function(e,n){for(var t=e[0],r=0,o=e.length;o>r;r++){var a=e[r];n(a,t)&&(t=a)}return t},i=function(e,n){for(var t=e.length-1;t>=0;t--){var r=e[t];n(r)&&e.splice(t,1)}return e},l=function(n,t){if(n){t||(t={w:e.innerWidth||document.documentElement.clientWidth,h:e.innerHeight||document.documentElement.clientHeight,x:e.devicePixelRatio||1});var r=n.slice(0),o=a(r,function(e,n){return e.w>n.w});i(r,function(){return function(e){return e.w<t.w}}(this)),0===r.length&&(r=[o]);var l=a(r,function(e,n){return e.h>n.h});i(r,function(){return function(e){return e.h<t.h}}(this)),0===r.length&&(r=[l]);var c=a(r,function(e,n){return e.x>n.x});i(r,function(){return function(e){return e.x<t.x}}(this)),0===r.length&&(r=[c]);var u=a(r,function(e,n){return e.w<n.w});i(r,function(e){return e.w>u.w});var f=a(r,function(e,n){return e.h<n.h});i(r,function(e){return e.h>f.h});var s=a(r,function(e,n){return e.x<n.x});return i(r,function(e){return e.x>s.x}),r[0]}},c=function(e){var t=[],r=e.src,a=e.srcset;if(a){var i=function(e){for(var n=0,r=t.length;r>n;n++){var o=t[n];if(o.x===e.x&&o.w===e.w&&o.h===e.h)return}t.push(e)},c=function(){for(var e,t,l=a,c=0,u=[];""!==l;){for(;" "===l.charAt(0);)l=l.slice(1);c=l.indexOf(" "),-1!==c?(e=l.slice(0,c),l=l.slice(c+1),c=l.indexOf(","),-1===c?(t=l,l=""):(t=l.slice(0,c),l=l.slice(c+1)),u.push({url:e,descriptors:t})):(u.push({url:l,descriptors:""}),l="")}for(var f=0,s=u.length;s>f;f++){var g=u[f],d=o(g.descriptors);i(new n({src:g.url,x:d.x,w:d.w,h:d.h}))}r&&i(new n({src:r}))};c();var u=l(t),f={best:u,candidates:t};return t=null,f}};return{get:c,image:l,throttle:t}}]),angular.module("afkl.lazyImage").directive("afklImageContainer",function(){"use strict";return{restrict:"A",controller:["$scope","$element",function(e,n){n.data("afklImageContainer",n)}]}}).directive("afklLazyImage",["$rootScope","$window","$timeout","afklSrcSetService","$parse",function(e,n,t,r,o){"use strict";var a=function(e){var n,t=r.get({srcset:e});return t&&(n=t.best.src),n};return{restrict:"A",link:function(i,l,c){var u=function(e){var n=[],t="afkl-lazy-image",r=!1;return m.imgAttrs&&(n=Array.prototype.map.call(e,function(e){for(var n in e)if(e.hasOwnProperty(n)){var o=e[n];return"class"===n&&(r=!0,o=o+" "+t),String.prototype.concat.call(n,'="',o,'"')}})),r||n.push('class="'+t+'"'),n.join(" ")},f=l.inheritedData("afklImageContainer");f||(f=angular.element(c.afklLazyImageContainer||n));var s,g=!1,d=c.afklLazyImage,m=c.afklLazyImageOptions?o(c.afklLazyImageOptions)(i):{},v=null,h=null,p=m.offset?m.offset:50,k=u(m.imgAttrs),y="afkl-lazy-image-loading";c.afklLazyImageLoaded=!1;var w=function(){if(f.scrollTop){var e=f.scrollTop();if(e)return e}var n=f[0];return void 0!==n.pageYOffset?n.pageYOffset:void 0!==n.scrollTop?n.scrollTop:document.documentElement.scrollTop||0},z=function(){if(f.innerHeight)return f.innerHeight();var e=f[0];return void 0!==e.innerHeight?e.innerHeight:void 0!==e.clientHeight?e.clientHeight:document.documentElement.clientHeight||0},I=function(){if(l.offset)return l.offset().top;var e=l[0].getBoundingClientRect();return e.top+w()-document.documentElement.clientTop},x=function(){return l.offset?l.offset().top-f.offset().top:l[0].getBoundingClientRect().top-f[0].getBoundingClientRect().top},$=function(){if(m.background)l[0].style.backgroundImage='url("'+h+'")';else{if(void 0===v)return;v[0].src=h}},L=function(){g=!0;var e=a(d);e&&(m.background||v||(l.addClass(y),v=angular.element("<img "+k+" />"),v.one("load",b),v.one("error",H),l.append(v)),C()),f.off("scroll",S)},C=function(){if(g){var e=a(d);e!==h&&(h=e,void 0!==v&&(m.background||void 0===v.one||(l.addClass(y),v.one("load",b),v.one("error",H))),$())}};C();var b=function(){c.$set("afklLazyImageLoaded","done"),l.removeClass(y)},H=function(){c.$set("afklLazyImageLoaded","fail")},S=function(){if(!g){var e,t,r,o=z(),a=w(),i=f[0]===n?I():x();r=f[0]===n?o+a:o,e=i-r,t=p>=e,t&&L()}},T=r.throttle(S,300),O=function(){t.cancel(s),s=t(function(){C(),S()},300)},A=function(){t.cancel(s),angular.element(n).off("resize",O),angular.element(n).off("scroll",T),f[0]!==n&&(f.off("resize",O),f.off("scroll",T)),v&&v.remove(),v=s=h=void 0};return angular.element(n).on("resize",O),angular.element(n).on("scroll",T),f[0]!==n&&(f.on("resize",O),f.on("scroll",T)),c.$observe("afklLazyImage",function(){d=c.afklLazyImage,g&&L()}),m.nolazy&&L(),i.$on("afkl.lazyImage.destroyed",O),i.$on("$destroy",function(){return e.$broadcast("afkl.lazyImage.destroyed"),A()}),S()}}}]);
